from unittest.mock import MagicMock\nimport json\nimport pytest\n\nfrom src.db.loader import DataLoader\n\n\n@pytest.fixture\ndef mock_conn():\n    conn = MagicMock()\n    cursor = MagicMock()\n    conn.cursor.return_value.__enter__.return_value = cursor\n    return conn\n\n\ndef test_load_to_staging_upsert_builds_expected_sql(mock_conn):\n    loader = DataLoader(mock_conn, batch_size=2)\n    records = [{"id": "a1", "foo": 1}, {"id": "a2", "foo": 2}]\n    count = loader.load_to_staging("dim_example_staging", records, job_id=1, run_id=2, key_field="id")\n    # Commit called\n    assert mock_conn.commit.called\n    # Batch size 2 -> single call to execute_values or loop fallback\n    assert count == 2\n\n\ndef test_bulk_insert_builds_expected_sql(mock_conn):\n    loader = DataLoader(mock_conn, batch_size=10)\n    records = [{"source_id": "s1", "x": 1}, {"source_id": "s2", "x": 2}]\n    count = loader.bulk_insert("dim_example_staging", records, job_id=11, run_id=22)\n    assert mock_conn.commit.called\n    assert count == 2\n\n\ndef test_upsert_records_without_lineage(mock_conn):\n    loader = DataLoader(mock_conn, batch_size=1)\n    records = [{"source_id": "s1", "v": 1}]\n    count = loader.upsert_records("dim_example_staging", records, key_field="source_id")\n    assert mock_conn.commit.called\n    assert count == 1\n\n\ndef test_truncate_and_reload(mock_conn):\n    loader = DataLoader(mock_conn, batch_size=5)\n    records = [{"source_id": "k1"}, {"source_id": "k2"}]\n    count = loader.truncate_and_reload("dim_example_staging", records, job_id=1, run_id=1)\n    # TRUNCATE executed then insert committed\n    assert mock_conn.cursor.return_value.__enter__.return_value.execute.called\n    assert mock_conn.commit.called\n    assert count == 2\n